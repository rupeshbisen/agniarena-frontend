name: Version Bump Workflow

on:
  pull_request:
    types: [closed]
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'

    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run quality checks
        run: npm run quality

      - name: Determine bump type from PR labels
        id: bump_type
        if: github.event_name == 'pull_request'
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'major') }}" == "true" ]]; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'minor') }}" == "true" ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Get version bump type
        id: version_type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "bump=${{ github.event.inputs.bump_type }}" >> $GITHUB_OUTPUT
          else
            echo "bump=${{ steps.bump_type.outputs.type }}" >> $GITHUB_OUTPUT
          fi

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: version_bump
        run: |
          npm version ${{ steps.version_type.outputs.bump }} --no-git-tag-version
          VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG
        run: |
          VERSION=${{ steps.version_bump.outputs.new_version }}
          DATE=$(date +%Y-%m-%d)

          # Create temporary file with updated changelog
          {
            echo "# Changelog"
            echo ""
            echo "All notable changes to this project will be documented in this file."
            echo ""
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),"
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."
            echo ""
            echo "## [Unreleased]"
            echo ""
            echo "### Added"
            echo ""
            echo "### Changed"
            echo ""
            echo "### Deprecated"
            echo ""
            echo "### Removed"
            echo ""
            echo "### Fixed"
            echo ""
            echo "### Security"
            echo ""
            echo "## [$VERSION] - $DATE"
            echo ""
            tail -n +10 CHANGELOG.md
          } > CHANGELOG.md.tmp

          mv CHANGELOG.md.tmp CHANGELOG.md

      - name: Commit and tag
        run: |
          VERSION=${{ steps.version_bump.outputs.new_version }}
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore(release): bump version to $VERSION"
          git tag -a "v$VERSION" -m "Release version $VERSION"

      - name: Push changes
        run: |
          git push origin main
          git push origin --tags

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version_bump.outputs.new_version }}
          release_name: Release v${{ steps.version_bump.outputs.new_version }}
          body: |
            See [CHANGELOG](./CHANGELOG.md) for details.
          draft: false
          prerelease: false

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Version bumped to v${{ steps.version_bump.outputs.new_version }}\n\nA release has been created with the updated changelog.'
            })
